<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Label Generator - 4x2 inch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding:0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            font-size: 13px;
        }
        .container {
            max-width: 900px;
            margin: 2px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #003366 0%, #005599 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        .header h1 { font-size: 1.6em; margin-bottom: 4px; }
        .header p { font-size: 0.9em; opacity: 0.9; }
        .content { padding: 16px; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: 600; color: #333; font-size: 0.85em; }
        select, input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            font-size: 0.85em;
            transition: all 0.3s ease;
            background: white;
        }
        select:focus, input:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.1); }
        .input-row { display: flex; gap: 10px; margin-bottom: 16px; }
        .input-row > div { flex: 1; }
        #itemSearch {
            padding-left: 32px;
            background: #f8f9fa url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23666" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.851a.5.5 0 0 0 .708-.708l-3.66-3.646zM8 10a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>') no-repeat 10px center;
            background-size: 16px;
        }

        .item-line { display: flex; align-items: center; gap: 8px; }
        .item-name-truncate { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 50ch; }
        .item-qty-inline { width: 70px; text-align: right; }
        .item-qty-group { background: #f8f9fa; border-radius: 8px; padding: 10px; margin-bottom: 8px; border: 1px solid #e1e5e9; transition: all 0.3s ease; }
        .item-qty-group:hover { border-color: #007bff; }
        .item-qty-group.hidden { display: none !important; }
        .item-header { margin-bottom: 6px; }
        .item-name { font-weight: 600; font-size: 0.9em; color: #333; }
        .item-meta { font-size: 0.75em; color: #666; margin-top: 2px; }
        .total-labels { background: #e3f2fd; padding: 8px; border-radius: 6px; margin: 10px 10px 0px 0px; font-weight: 600; text-align: center; font-size: 0.85em; }
        .generate-btn { background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 10px 20px; border: none; border-radius: 22px; font-size: 0.95em; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s ease; margin-top: 8px; }
        .generate-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 8px 16px rgba(40,167,69,0.4); }
        .generate-btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        .status { padding: 8px; border-radius: 6px; margin: 12px 0; font-weight: 500; font-size: 0.85em; display: none; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        @media (max-width: 768px) {
            .input-row { flex-direction: column; gap: 12px; }
            .content { padding: 12px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Label Generator</h1>
        <p>Select Type ‚Üí City (if applicable) ‚Üí MFG Date ‚Üí Batch No + Search ‚Üí Set Labels per Item ‚Üí Generate 4√ó2 inch Labels</p>
    </div>
    <div class="content">
        <div id="status" class="status"></div>

        <div id="formSection" style="display:none;">
            <div class="form-group">
                <label>Select Label Type</label>
                <select id="labelTypeSelect">
                    <option value="">Select Type</option>
                    <option value="fssai-labels">Fssai Labels</option>
                    <option value="airportFssai">Airport Fssai Labels</option>
                    <option value="nonfssai">Non Fssai Labels</option>
                    <option value="airportContinental">Airport Continental</option>
                    <option value="intercity">Intercity</option>
                </select>
            </div>
            <div class="form-group" id="cityGroup" style="display:none;">
                <label>Select City</label>
                <select id="citySelect">
                    <option value="">Loading cities...</option>
                </select>
            </div>

            <div class="input-row">
                <div class="form-group">
                    <label>üìÖ MFG Date *</label>
                    <input type="date" id="mfgDateInput" required>
                </div>
                <div class="form-group">
                    <label for="batchNoInput">Batch No</label>
                    <input type="text" id="batchNoInput" placeholder="Enter Batch No (e.g., BATCH001)">
                </div>
                <div class="form-group">
                    <label for="itemSearch">üîç Search Items</label>
                    <input type="text" id="itemSearch" placeholder="Type to filter items..." autocomplete="off">
                </div>
            </div>

            <div id="itemsSection">
                <div style="padding: 10px; text-align: center; color: #999; font-size: 0.85em;">
                    Select label type and city to load items.
                </div>
            </div>

            <div class="total-labels" id="totalLabels" style="display:none;">
                Total Labels to Print: <span id="totalCount">0</span>
            </div>

            <button class="generate-btn" id="generateBtn" onclick="generateLabels()" disabled>
                Generate Labels Preview
            </button>
        </div>
    </div>
</div>

<script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWyIwiF7ZY7XC1-oNAJ0VxK3K2E_2RyLVfZUEKcEQ_xtFGHh8Ro5XZ9-fxkY-ZYxZ0bg/exec';
    let excelData = { items: [], address: [], airportfssai: [], nonfssai:[], airportcontinental:[], intercity: [] };
    let cleanedItemsCache = [];
    let allItemElements = [];
    let itemQuantities = {};
    let currentLabelType = '';

    function showStatus(message, type) {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = `status ${type}`;
        status.style.display = 'block';
        setTimeout(() => status.style.display = 'none', 4000);
    }

    function formatExcelDate(value) {
        if (!value) return 'NA';
        if (value instanceof Date && !isNaN(value)) {
            const d = value;
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}-${month}-${year}`;
        }
        if (typeof value === 'number') {
            const excelEpoch = new Date(1899, 11, 30);
            const d = new Date(excelEpoch.getTime() + (value * 86400000));
            if (!isNaN(d)) {
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return `${day}-${month}-${year}`;
            }
        }
        const parsed = new Date(value);
        if (!isNaN(parsed)) {
            const day = String(parsed.getDate()).padStart(2, '0');
            const month = String(parsed.getMonth() + 1).padStart(2, '0');
            const year = parsed.getFullYear();
            return `${day}-${month}-${year}`;
        }
        return value ? value.toString() : 'NA';
    }

    function setTodayDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('mfgDateInput').value = today;
    }

    function setupSearch() {
        const searchInput = document.getElementById('itemSearch');
        searchInput.addEventListener('input', function() {
            const term = this.value.toLowerCase().trim();
            allItemElements.forEach(el => {
                const name = el.querySelector('.item-name')?.textContent.toLowerCase() || '';
                el.classList.toggle('hidden', term && !name.includes(term));
            });
            updateTotalLabels();
        });
    }

    async function loadDataFromAppsScript() {
        try {
            showStatus('Loading data from Google Sheets...', 'info');
            const res = await fetch(APPS_SCRIPT_URL);
            const data = await res.json();
            excelData.items = data.items || [];
            excelData.address = data.address || [];
            excelData.airportfssai = data.airportfssai || [];
            excelData.nonfssai = data.nonfssai || [];
            excelData.airportcontinental = data.airportcontinental || [];
            excelData.intercity = data.intercity || [];
            document.getElementById('formSection').style.display = 'block';
            showStatus(`Loaded data from sheets`, 'success');
            setupLabelTypeHandler();
            setTodayDate();
        } catch (err) {
            showStatus('Error: ' + err.message, 'error');
        }
    }

    // === FSSAI LABELS SPECIFIC FUNCTIONS ===
    function loadFssaiLabelsItems(city) {
        cleanedItemsCache = cleanItemsData(excelData.items);
        populateDetailedItemsQuantities();
        showStatus(`Loaded ${cleanedItemsCache.length} Fssai Labels items`, 'success');
    }

    function loadNonFssaiLabelsItems(city) {
        cleanedItemsCache = cleanItemsData(excelData.nonfssai);
        populateDetailedItemsQuantities();
        showStatus(`Loaded ${cleanedItemsCache.length} Non Fssai Labels items`, 'success');
    }

    function cleanItemsData(items) {
        return (items || []).map(item => {
            const cleaned = { ...item };
            
            // Handle various column name variations
            if (item['Item No']) cleaned.ItemNo = item['Item No'];
            if (item['Item Name']) cleaned.ItemName = item['Item Name'];
            if (item['ItemNo']) cleaned.ItemNo = item['ItemNo'];
            if (item['ItemName']) cleaned.ItemName = item['ItemName'];
            if (item['Shelf Life']) cleaned.ShelfLife = item['Shelf Life'];
            if (item['MRP (‚Çπ)']) cleaned.MRP = item['MRP (‚Çπ)'];
            if (item['USP (‚Çπ)']) cleaned.USP = item['USP (‚Çπ)'];
            if (item['Weight (gms)']) cleaned.Weight = item['Weight (gms)'];
            if (item['Pieces (pcs)']) cleaned.Pieces = item['Pieces (pcs)'];
            if (item['Qty (in units)']) cleaned.Qty = item['Qty (in units)'];

            // Nutrition info variations
            if (item['NUTRITIONAL INFORMATION-per 100 gms (approx)']) {
                cleaned.NutritionInfo = item['NUTRITIONAL INFORMATION-per 100 gms (approx)'];
            } else if (item['NUTRITIONAL INFORMATION Per 100 gms approx']) {
                cleaned.NutritionInfo = item['NUTRITIONAL INFORMATION Per 100 gms approx'];
            }

            // Numeric fields
            ['ShelfLife', 'MRP', 'USP', 'Weight', 'Pieces', 'Qty'].forEach(col => {
                if (cleaned[col] !== undefined && cleaned[col] !== null && cleaned[col] !== '') {
                    const num = parseFloat(cleaned[col]);
                    if (!isNaN(num)) cleaned[col] = num;
                }
            });

            cleaned.ShelfLife = parseInt(item['Shelf Life']) || parseInt(item.ShelfLife) || 0;
            return cleaned;
        }).filter(i => i.ItemNo || i.No);
    }

    function populateDetailedItemsQuantities() {
        const container = document.getElementById('itemsSection');
        container.innerHTML = '';
        allItemElements = [];
        itemQuantities = {};

        if (!cleanedItemsCache.length) {
            container.innerHTML = `
                <div style="padding: 10px; text-align: center; color: #999; font-size: 0.85em;">
                    No valid items found
                </div>`;
            return;
        }

        cleanedItemsCache.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'item-qty-group';
            div.dataset.index = index;

            const shelfLifeDisplay = item.ShelfLife || 'NA';
            if (currentLabelType === 'intercity') {
                div.innerHTML = `
                    <div class="item-header">
                        <div class="item-line">
                            <div class="item-name item-name-truncate">
                                ${item.ItemName || item['Item Name'] || 'NA'}
                                <span class="item-count" id="item-count-${index}"
                                    style="font-size:0.8em; color:#007bff; margin-left:6px;">0</span>
                            </div>
                            <input type="number"
                                class="qty-input item-qty-inline"
                                data-index="${index}"
                                min="0"
                                max="500"
                                value=""
                                onchange="updateTotalLabels()"
                                title="Number of labels">
                        </div>
                        <div class="item-meta">
                            From: ${item['From City'] || item.FromCity || 'NA'} |
                            To: ${item['To City'] || item.ToCity || 'NA'} |
                            Category: ${item.Category || 'NA'} |
                            Shelf Life: ${shelfLifeDisplay} days
                        </div>
                    </div>
                `;
            }

            else {
                const mrpDisplay = item.MRP || 'NA';
                const uspDisplay = item.USP || 'NA';

                div.innerHTML = `
                    <div class="item-header">
                        <div class="item-line">
                            <div class="item-name item-name-truncate">
                                ${item.ItemName || 'NA'}
                                <span class="item-count" id="item-count-${index}"
                                    style="font-size:0.8em; color:#007bff; margin-left:6px;">0</span>
                            </div>
                            <input type="number"
                                class="qty-input item-qty-inline"
                                data-index="${index}"
                                min="0"
                                max="500"
                                value=""
                                onchange="updateTotalLabels()"
                                title="Number of labels">
                        </div>
                        <div class="item-meta">
                            Item ${item.ItemNo || 'NA'} |
                            ${item.Pieces || 'NA'} pcs ${item.Weight || 'NA'}g |
                            MRP ${mrpDisplay} | USP ${uspDisplay} |
                            Shelf Life: ${shelfLifeDisplay} days
                        </div>
                    </div>
                `;
            }

            container.appendChild(div);
            allItemElements.push(div);
        });
        setupSearch();
    }

    // === VALIDATION FUNCTIONS ===
    function validateBatchNo(labelType) {
        const batchNo = document.getElementById('batchNoInput').value.trim();
        
        if (labelType === 'fssai-labels' && !batchNo) {
            showStatus('Batch No is mandatory for FSSAI labels', 'error');
            return false;
        }
        
        if (labelType === 'intercity') {
            // For intercity, batch no is not used at all
            const batchNo = document.getElementById('batchNoInput').value.trim(); // Optional for intercity
        }
        
        return true;
    }

    // === FSSAI LABEL GENERATION ===
    function generateFssaiLabels() {
        if (!validateBatchNo('fssai-labels')) return;
        
        const totalLabels = Object.values(itemQuantities).reduce((sum, qty) => sum + (qty || 0), 0);
        if (!totalLabels) {
            showStatus('Set at least 1 label for some items', 'error');
            return;
        }

        const mfgDateInput = document.getElementById('mfgDateInput').value;
        if (!mfgDateInput) {
            showStatus('Please select MFG Date before generating labels', 'error');
            return;
        }

        const city = document.getElementById('citySelect').value;
        if (!city) {
            showStatus('Please select a City before generating labels', 'error');
            return;
        }

        showStatus('Generating preview...', 'info');

        const cityName = document.getElementById('citySelect').value.toLowerCase();
        const addressInfo = (excelData.address || []).find(row =>
            (row.City || '').toString().trim().toLowerCase() === cityName
        );
        const batchNo = document.getElementById('batchNoInput').value.trim();

        const finalItems = [];
        Object.entries(itemQuantities).forEach(([indexStr, qty]) => {
            qty = parseInt(qty || 0, 10);
            if (qty > 0) {
                const index = parseInt(indexStr, 10);
                const item = cleanedItemsCache[index];

                const mfgDate = new Date(mfgDateInput);
                const shelfLifeDays = parseInt(item.ShelfLife) || 0;
                const useByDate = new Date(mfgDate);
                useByDate.setDate(useByDate.getDate() + shelfLifeDays);

                const mfgDateFormatted = formatExcelDate(mfgDate);
                const useByDateFormatted = formatExcelDate(useByDate);

                for (let i = 0; i < qty; i++) {
                    finalItems.push({
                        ...item,
                        City: cityName,
                        CorpAddress: addressInfo ? (addressInfo['Corp Address'] || addressInfo.CorpAddress || 'NA') : 'NA',
                        FSSAI: addressInfo ? (addressInfo.FSSAI || 'NA') : 'NA',
                        MfgAddress: addressInfo ? (addressInfo['Mfg Address'] || addressInfo.MfgAddress || 'NA') : 'NA',
                        NutritionInfo: item.NutritionInfo || 'Follow FSSAI RDA Norms',
                        MFDDate: mfgDateFormatted,
                        UsedByDate: useByDateFormatted,
                        BatchNo: batchNo,
                        ShelfLifeDays: shelfLifeDays
                    });
                }
            }
        });

        if (!finalItems.length) {
            showStatus('No labels to generate. Please set quantities.', 'error');
            return;
        }

        const previewHtml = generateFssaiPreviewHtml(finalItems);
        openDetailedPreviewWindow(previewHtml);
        showStatus('Preview opened in a new tab. ' + finalItems.length + ' labels generated.', 'success');
    }

    function generateFssaiPreviewHtml(items) {
        let html = '';
        items.forEach(item => {
            const netQty = `${item.Pieces || 'N/A'} pcs (@${item.Weight || 'N/A'}Gms)`;
            const basePriceVal = item.BasePrice || item['Base Price'] || '';
            const gstVal = item.GST || item['GST %'] || item['GST'] || '';

            let priceExtras = '';
            if (basePriceVal || gstVal) {
                priceExtras =
                    '<br> (' +
                    (basePriceVal ? `‚Çπ${basePriceVal}` : '') +
                    (basePriceVal && gstVal ? ', ' : '') +
                    (gstVal ? `‚Çπ${gstVal}` : '') +
                    ')';
            }

            const mrpUsp =
                (item.MRP || item.USP)
                    ? `‚Çπ${item.MRP || 'N/A'} / ‚Çπ${item.USP || 'N/A'}${priceExtras}`
                    : `N/A / N/A${priceExtras}`;

            const itemNameClean = (item.ItemName || '').toLowerCase().replace(/[()]/g, '').replace(/[']/g, '').trim().replace(/\s+/g, '-');
            const qrPayload = "http://Harleys.com/FssaiText.html#" + itemNameClean;
            const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=' + encodeURIComponent(qrPayload);

            html += `
            <div class="preview-label">
                <div class="column1">
                    <div class="label-top">
                    <div class="label-brand">HARLEYS INDIA PVT LTD</div>
                    <div class="item-title">${item.ItemName || 'NA'}</div>
                </div>
                <div style="font-size: 9px; margin-bottom: 2px; display:flex; justify-content:space-between;">
                    <span style="min-width: 45px; display: inline-block;">NET QTY</span>
                    <span style="flex:1; text-align:right;">${netQty}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 3px; display:flex; justify-content:space-between;">
                    <span style="min-width: 50px; display: inline-block;">MRP / USP(per Gm)</span>
                    <span style="flex:1; text-align:right;">${mrpUsp}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 2px; display:flex; justify-content:space-between;">
                    <span style="min-width: 30px; display: inline-block;">MFD</span>
                    <span style="flex:1; text-align:right;">${item.MFDDate || 'NA'}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 3px; display:flex; justify-content:space-between;">
                    <span style="min-width: 40px; display: inline-block;">USE BY</span>
                    <span style="flex:1; text-align:right;">${item.UsedByDate || 'NA'}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 3px; display:flex; justify-content:space-between;">
                    <span style="min-width: 50px; display: inline-block;">FSSAI</span>
                    <span style="flex:1; text-align:right;">${item.FSSAI || 'NA'}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 3px; display:flex; justify-content:space-between;">
                    <span style="min-width: 50px; display: inline-block;">BATCH NO</span>
                    <span style="flex:1; text-align:right;">${item.BatchNo || 'NA'}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 3px; display:flex; justify-content:space-between;">
                    <span style="min-width: 55px; display: inline-block;">MFG ADDRESS</span>
                    <span class="mfg-value" style="font-size: 8px ; flex:1; text-align:right;">${item.MfgAddress || 'NA'}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 3px; display:flex; justify-content:space-between;">
                    <span style="min-width: 55px; display: inline-block;"> CORP ADDRESS</span>
                    <span class="mfg-value" style="font-size: 8px ; flex:1; text-align:right;">${item.CorpAddress || 'NA'}</span>
                </div>
                </div>
                <div class="column2">
                    <div class="qr-box">
                        <img src="${qrUrl}" alt="QR CODE" onerror="this.style.display='none';this.nextElementSibling.style.display='block';">
                        <div style="font-size: 8px; display: none;">FSSAI & Nutrition Info</div>
                    </div>
                    <div style="font-size: 8px; margin: 5px; font-weight: bold; text-align: center;">
                        FSSAI & Nutrition Info
                    </div>
                    <div class="exec-line">Customer Care: 8083098888</div>
                    <div class="exec-mail">Email: care@harleys.com</div>
                </div>
            </div>`;
        });
        return html;
    }

    function generateAirportFssaiLabels() {
        if (!validateBatchNo('fssai-labels')) return;
        
        const totalLabels = Object.values(itemQuantities).reduce((sum, qty) => sum + (qty || 0), 0);
        if (!totalLabels) {
            showStatus('Set at least 1 label for some items', 'error');
            return;
        }

        const mfgDateInput = document.getElementById('mfgDateInput').value;
        if (!mfgDateInput) {
            showStatus('Please select MFG Date before generating labels', 'error');
            return;
        }

        const city = document.getElementById('citySelect').value;
        if (!city) {
            showStatus('Please select a City before generating labels', 'error');
            return;
        }

        showStatus('Generating preview...', 'info');

        const cityName = document.getElementById('citySelect').value.toLowerCase();
        const addressInfo = (excelData.address || []).find(row =>
            (row.City || '').toString().trim().toLowerCase() === cityName
        );
        const batchNo = document.getElementById('batchNoInput').value.trim();

        const finalItems = [];
        Object.entries(itemQuantities).forEach(([indexStr, qty]) => {
            qty = parseInt(qty || 0, 10);
            if (qty > 0) {
                const index = parseInt(indexStr, 10);
                const item = cleanedItemsCache[index];

                const mfgDate = new Date(mfgDateInput);
                const shelfLifeDays = parseInt(item.ShelfLife) || 0;
                const useByDate = new Date(mfgDate);
                useByDate.setDate(useByDate.getDate() + shelfLifeDays);

                const mfgDateFormatted = formatExcelDate(mfgDate);
                const useByDateFormatted = formatExcelDate(useByDate);

                for (let i = 0; i < qty; i++) {
                    finalItems.push({
                        ...item,
                        City: cityName,
                        CorpAddress: addressInfo ? (addressInfo['Corp Address'] || addressInfo.CorpAddress || 'NA') : 'NA',
                        FSSAI: addressInfo ? (addressInfo.FSSAI || 'NA') : 'NA',
                        MfgAddress: addressInfo ? (addressInfo['Mfg Address'] || addressInfo.MfgAddress || 'NA') : 'NA',
                        NutritionInfo: item.NutritionInfo || 'Follow FSSAI RDA Norms',
                        MFDDate: mfgDateFormatted,
                        UsedByDate: useByDateFormatted,
                        BatchNo: batchNo,
                        ShelfLifeDays: shelfLifeDays
                    });
                }
            }
        });

        if (!finalItems.length) {
            showStatus('No labels to generate. Please set quantities.', 'error');
            return;
        }

        const previewHtml = generateAirportFssaiPreviewHtml(finalItems);
        openDetailedPreviewWindow(previewHtml);
        showStatus('Preview opened in a new tab. ' + finalItems.length + ' labels generated.', 'success');
    }

    function generateAirportFssaiPreviewHtml(items) {
        let html = '';
        items.forEach(item => {
            const netQty = `${item.Pieces || 'N/A'} pcs (@${item.Weight || 'N/A'}Gms)`;
            const basePriceVal = item.BasePrice || item['Base Price'] || '';
            const gstVal = item.GST || item['GST %'] || item['GST'] || '';

            let priceExtras = '';
            if (basePriceVal || gstVal) {
                priceExtras =
                    '<br> (' +
                    (basePriceVal ? `‚Çπ${basePriceVal}` : '') +
                    (basePriceVal && gstVal ? ', ' : '') +
                    (gstVal ? `‚Çπ${gstVal}` : '') +
                    ')';
            }

            const mrpUsp =
                (item.MRP || item.USP)
                    ? `‚Çπ${item.MRP || 'N/A'} / ‚Çπ${item.USP || 'N/A'}${priceExtras}`
                    : `N/A / N/A${priceExtras}`;

            const itemNameClean = (item.ItemName || '').toLowerCase().replace(/[()]/g, '').replace(/[']/g, '').trim().replace(/\s+/g, '-');
            const qrPayload = "http://Harleys.com/FssaiText.html#" + itemNameClean;
            const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=' + encodeURIComponent(qrPayload);

            html += `
            <div class="preview-label">
                <div class="column1">
                    <div class="label-top">
                    <div class="label-brand">HARLEYS INDIA PVT LTD</div>
                    <div class="item-title">${item.ItemName || 'NA'}</div>
                </div>
                <div style="font-size: 9px; margin-bottom: 2px; display:flex; justify-content:space-between;">
                    <span style="min-width: 45px; display: inline-block;">NET QTY</span>
                    <span style="flex:1; text-align:right;">${netQty}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 3px; display:flex; justify-content:space-between;">
                    <span style="min-width: 50px; display: inline-block;">MRP / USP(per Gm)</span>
                    <span style="flex:1; text-align:right;">${mrpUsp}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 2px; display:flex; justify-content:space-between;">
                    <span style="min-width: 30px; display: inline-block;">MFD</span>
                    <span style="flex:1; text-align:right;">${item.MFDDate || 'NA'}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 3px; display:flex; justify-content:space-between;">
                    <span style="min-width: 40px; display: inline-block;">USE BY</span>
                    <span style="flex:1; text-align:right;">${item.UsedByDate || 'NA'}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 3px; display:flex; justify-content:space-between;">
                    <span style="min-width: 50px; display: inline-block;">FSSAI</span>
                    <span style="flex:1; text-align:right;">${item.FSSAI || 'NA'}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 3px; display:flex; justify-content:space-between;">
                    <span style="min-width: 50px; display: inline-block;">BATCH NO</span>
                    <span style="flex:1; text-align:right;">${item.BatchNo || 'NA'}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 3px; display:flex; justify-content:space-between;">
                    <span style="min-width: 55px; display: inline-block;">MFG ADDRESS</span>
                    <span class="mfg-value" style="font-size: 7px ; flex:1; text-align:right;">${item.MfgAddress || 'NA'}</span>
                </div>
                <div style="font-size: 9px; margin-bottom: 3px; display:flex; justify-content:space-between;">
                    <span style="min-width: 55px; display: inline-block;"> CORP ADDRESS</span>
                    <span class="mfg-value" style="font-size: 7px ; flex:1; text-align:right;">${item.CorpAddress || 'NA'}</span>
                </div>
                </div>
                <div class="column2">
                    <div class="qr-box">
                        <img src="${qrUrl}" alt="QR CODE" onerror="this.style.display='none';this.nextElementSibling.style.display='block';">
                        <div style="font-size: 8px; display: none;">FSSAI & Nutrition Info</div>
                    </div>
                    <div style="font-size: 8px; margin: 5px; font-weight: bold; text-align: center;">
                        FSSAI & Nutrition Info
                    </div>
                    <div class="exec-line">Customer Care: 8083098888</div>
                    <div class="exec-mail">Email: care@harleys.com</div>
                </div>
            </div>`;
        });
        return html;
    }

    function generateNonFssaiLabels() {
        console.log('---- [Non-FSSAI] Generation Started ----');

        console.log('[Non-FSSAI] cleanedItemsCache:', cleanedItemsCache);
        console.log('[Non-FSSAI] itemQuantities:', itemQuantities);

        const totalLabels = Object.values(itemQuantities)
            .reduce((sum, qty) => sum + (parseInt(qty) || 0), 0);

        console.log('[Non-FSSAI] Total labels requested:', totalLabels);

        if (!totalLabels) {
            console.error('[Non-FSSAI] No quantities set');
            showStatus('Set at least 1 label for some items', 'error');
            return;
        }

        const mfgDateInput = document.getElementById('mfgDateInput').value;
        console.log('[Non-FSSAI] MFG Date Input:', mfgDateInput);

        if (!mfgDateInput) {
            console.error('[Non-FSSAI] MFG Date missing');
            showStatus('Please select MFG Date', 'error');
            return;
        }

        const mfgDate = new Date(mfgDateInput);
        let previewHtml = '';
        let labelCounter = 0;

        Object.entries(itemQuantities).forEach(([index, qty]) => {
            qty = parseInt(qty, 10);

            if (qty > 0) {
                const item = cleanedItemsCache[index];
                console.log(`[Non-FSSAI] Processing item index ${index}`, item);

                const shelfLife = parseInt(item.ShelfLife) || 0;
                const useBy = new Date(mfgDate);
                useBy.setDate(useBy.getDate() + shelfLife);

                for (let i = 0; i < qty; i++) {
                    labelCounter++;

                    previewHtml += `
                    <div class="preview-label">
                        <div class="label-header">HARLEYS INDIA PVT LTD</div>
                        <div class="label-content">
                            <div class="label-row">
                                <span class="label-field">Item:</span>
                                <span>${item.ItemName || 'NA'}</span>
                            </div>
                            <div class="label-row">
                                <span class="label-field">Category:</span>
                                <span>${item.Category || 'NA'}</span>
                            </div>
                            <div class="label-row">
                                <span class="label-field">MFG Date:</span>
                                <span>${formatExcelDate(mfgDate)}</span>
                            </div>
                            <div class="label-row">
                                <span class="label-field">Use By:</span>
                                <span>${formatExcelDate(useBy)}</span>
                            </div>
                            ${item.Remarks ? `
                            <div class="remarks-section">
                                <strong>Remarks:</strong> ${item.Remarks}
                            </div>` : ''}
                        </div>
                    </div>`;
                }
            }
        });

        console.log('[Non-FSSAI] Labels built:', labelCounter);

        if (!previewHtml) {
            console.error('[Non-FSSAI] previewHtml empty');
            showStatus('No labels generated', 'error');
            return;
        }

        console.log('[Non-FSSAI] Opening preview window');
        openNonFssaiPreviewWindow(previewHtml);

        showStatus(
            `Non-FSSAI preview opened (${labelCounter} labels)`,
            'success'
        );
    }

    function openDetailedPreviewWindow(previewHtml) {
        const win = window.open('', '_blank');
        win.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Fssai Labels Preview</title>
            <style>
                html, body {
                    margin: 0; padding: 0; width: 4.094in; height: 2in; box-sizing: border-box;
                    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; font-size: 8px;
                    -webkit-print-color-adjust: exact; print-color-adjust: exact;
                }
                body { display: flex; align-items: flex-start; justify-content: flex-start; background: #f8f9fa; padding: 0; }
                .preview-labels { display: flex; flex-direction: column; gap: 0; padding: 0; margin: 0; }
                .preview-label {
                    background: #ffffff; border: 1px solid #000; width: 4.094in; height: 2in; box-sizing: border-box;
                    padding: 0.01in 0.1in; display: grid; grid-template-columns: 1.1fr 0.9fr; color: #000; font-size: 6px;
                    line-height: 1.0; page-break-inside: avoid; page-break-after: always; font-weight: bold !important;
                    color: #000 !important; margin: 0; position: relative; top: 0;
                }
                .column1, .column2 { padding: 0.02in; overflow: hidden; }
                .label-top { text-align: center; margin-bottom: 2px; }
                .label-brand { font-size: 10px; font-weight: 700; }
                .item-title { font-size: 9px; font-weight: 700; margin-top: 1px; margin-bottom: 3px; }
                .qr-box { width: 1.2in; height: 1.2in; margin: 0 auto; border: 1px solid #333; display: flex; align-items: center; justify-content: center; }
                .qr-box img { width: 100%; height: 100%; object-fit: contain; }
                .exec-line { font-size: 9px; font-weight: 700; text-align: center; margin-top: 0px; }
                .exec-mail { font-size: 9px; font-weight: 700; text-align: center; margin-bottom: 4px; }
                .print-bar { margin: 0px 0 5px 0; text-align: right; }
                .print-btn { background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 6px 16px; border: none; border-radius: 16px; font-size: 0.9em; cursor: pointer; }
                @page { size: 4.094in 2in; margin: 0; padding: 0; }
                @media print {
                    html, body { margin: 0 !important; padding: 0 !important; }
                    body { background: #ffffff; width: 4.094in; height: 2in; display: block; }
                    .print-bar { display: none !important; }
                    .preview-labels { margin: 0 !important; padding: 0 !important; display: block; }
                    .preview-label { 
                        margin: 0 !important; 
                        padding-top: 0.2in !important;
                        padding-left: 0.1in !important;
                        padding-right: 0.1in !important;
                        border: 1px solid #000; 
                        page-break-after: always; 
                        position: relative;
                        top: 0 !important;
                    }
                    .preview-label:last-child { page-break-after: avoid; }
                }
            </style>
        </head>
        <body>
            <div class="print-bar">
                <button class="print-btn" onclick="window.print()">Print Labels</button>
            </div>
            <div class="preview-labels">${previewHtml}</div>
        </body>
        </html>`);
        win.document.close();
    }

    // === AIRPORT LABELS (Batch No optional) ===
    function generateAirportContinentalLabels() {
        const totalLabels = Object.values(itemQuantities)
            .reduce((sum, qty) => sum + (qty || 0), 0);

        if (!totalLabels) {
            showStatus('Set at least 1 label for some items', 'error');
            return;
        }

        const mfgDateInput = document.getElementById('mfgDateInput').value;
        if (!mfgDateInput) {
            showStatus('Please select MFG Date before generating labels', 'error');
            return;
        }

        const city = document.getElementById('citySelect').value;
        if (!city) {
            showStatus('Please select a City before generating labels', 'error');
            return;
        }

        const batchNo = document.getElementById('batchNoInput').value.trim();
        const mfgDate = new Date(mfgDateInput);
        const addressInfo = excelData.address.find(a => a.City === city) || {};
        const labels = [];

        Object.entries(itemQuantities).forEach(([i, qty]) => {
            qty = parseInt(qty, 10);
            if (qty > 0) {
                const item = cleanedItemsCache[i];
                const useBy = new Date(mfgDate);
                useBy.setDate(useBy.getDate() + (item.ShelfLife || 0));

                for (let j = 0; j < qty; j++) {
                    labels.push({
                        ItemName: item.ItemName || 'NA',
                        Category: item.Category || 'NA',
                        UseByDate: formatExcelDate(useBy),
                        FSSAI: addressInfo.FSSAI || 'NA',
                        BatchNo: batchNo || ''
                    });
                }
            }
        });

        if (!labels.length) {
            showStatus('No labels generated', 'error');
            return;
        }

        // ‚úÖ GROUP INTO PAGES OF 4
        const pages = chunkArray(labels, 4);

        const win = window.open('', '_blank');
        win.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
            <title>Airport Continental Labels</title>
            <style>
            * { box-sizing: border-box; }

            @page {
            size: 4in 2in;
            margin: 0;
            }

            /* BODY HEIGHT MUST BE AUTO */
            html, body {
            margin: 0;
            padding: 0;
            width: 4in;
            font-family: Arial, sans-serif;
            }

            .page {
            width: 4in;
            height: 2in;
            display: grid;
            grid-template-columns: 2in 2in;
            grid-template-rows: 1in 1in;
            page-break-after: always;
            }

            .page:last-child {
            page-break-after: avoid;
            }

            .label {
            width: 2in;
            height: 1in;
            border: 1px solid #000;
            padding: 4px;
            font-size: 8px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            overflow: hidden;
            }
            </style>
            </head>
            <body>

            ${pages.map(page => `
            <div class="page">
                ${page.map(l => `
                <div class="label">
                    <div>HARLEYS INDIA PVT LTD</div>
                    <div>${l.ItemName}</div>
                    <div>Best By: ${l.UseByDate}</div>
                    ${l.BatchNo ? `<div>Batch No: ${l.BatchNo}</div>` : ''}
                    ${
                        l.ItemName?.toLowerCase() !== 'harleys trays'
                        ? `
                            <div>FSSAI: ${l.FSSAI}</div>
                            <div>CATEGORY: ${l.Category}</div>
                        `
                        : ''
                    }
                </div>
                `).join('')}
            </div>
            `).join('')}

            </body>
            </html>
        `);
        win.document.close();

        showStatus(
            'Preview opened. ' + labels.length + ' airport labels generated.',
            'success'
        );
    }

    function chunkArray(arr, size) {
        const chunks = [];
        for (let i = 0; i < arr.length; i += size) {
            chunks.push(arr.slice(i, i + size));
        }
        return chunks;
    }

    // === INTERCITY LABELS (Updated logic) ===
    function generateIntercityLabels() {
        const totalLabels = Object.values(itemQuantities)
            .reduce((sum, qty) => sum + (qty || 0), 0);

        if (!totalLabels) {
            showStatus('Set at least 1 label for some items', 'error');
            return;
        }

        const mfgDateInput = document.getElementById('mfgDateInput').value;
        if (!mfgDateInput) {
            showStatus('Please select MFG Date before generating labels', 'error');
            return;
        }

        const mfgDateFormatted = formatExcelDate(new Date(mfgDateInput));
        const labels = [];

        Object.entries(itemQuantities).forEach(([i, qty]) => {
            qty = parseInt(qty, 10);
            if (qty > 0) {
                const item = cleanedItemsCache[i];
                const showMFGDate =
                    (item.MFGD || '').toString().trim().toLowerCase() === 'yes';

                for (let j = 0; j < qty; j++) {
                    labels.push({
                        ...item,
                        ItemName: item.ItemName || 'NA',
                        Category: item.Category || 'NA',
                        MFGDate: showMFGDate ? mfgDateFormatted : null
                    });
                }
            }
        });

        if (!labels.length) {
            showStatus('No labels generated', 'error');
            return;
        }

        const pages = chunkArray(labels, 4);

        const win = window.open('', '_blank');
        win.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
            <title>Intercity Labels</title>
            <style>
            * { box-sizing: border-box; }

            @page {
            size: 4in 2in;
            margin: 0;
            }

            /* ‚úÖ BODY MUST BE AUTO HEIGHT */
            html, body {
            margin: 0;
            padding: 0;
            width: 4in;
            font-family: Arial, sans-serif;
            }

            .page {
            width: 4in;
            height: 2in;
            display: grid;
            grid-template-columns: 2in 2in;
            grid-template-rows: 1in 1in;
            page-break-after: always;
            }

            .page:last-child {
            page-break-after: avoid;
            }

            .label {
            width: 2in;
            height: 1in;
            border: 1px solid #000;
            padding: 4px;
            font-size: 8px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            overflow: hidden;
            }
            </style>
            </head>
            <body>

            ${pages.map(page => `
            <div class="page">
                ${page.map(l => `
                <div class="label">
                    <div>HARLEYS INDIA PVT LTD</div>
                    <div style="font-size:8px">${l.ItemName}</div>
                    <div>CATEGORY: ${l.Category}</div>
                    ${l.MFGDate ? `<div>MFG DATE: ${l.MFGDate}</div>` : ''}
                    ${Object.keys(l).map(key => {
                        if (
                            !['ItemName','Category','MFGD','MFGDate','Shelf Life','No','Item Name'].includes(key)
                            && l[key]
                            && l[key] !== 'NA'
                        ) {
                            return `<div>${key.replace(/([A-Z])/g,' $1').trim()}: ${l[key]}</div>`;
                        }
                        return '';
                    }).join('')}
                </div>
                `).join('')}
            </div>
            `).join('')}

            </body>
            </html>
        `);
        win.document.close();

        showStatus(
            'Preview opened. ' + labels.length +
            ' labels generated successfully',
            'success'
        );
    }


    function populateCities() {
        const cities = [...new Set((excelData.address || []).map(r => r.City).filter(Boolean))];
        const select = document.getElementById('citySelect');
        select.innerHTML = '<option value="">Select City</option>' + cities.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function updateTotalLabels() {
        let total = 0;
        document.querySelectorAll('.qty-input').forEach(input => {
            const idx = parseInt(input.dataset.index);
            const qty = parseInt(input.value) || 0;
            itemQuantities[idx] = qty;
            total += qty;
            const countSpan = document.getElementById(`item-count-${idx}`);
            if (countSpan) countSpan.textContent = qty;
        });
        const totalDiv = document.getElementById('totalLabels');
        totalDiv.style.display = total ? 'block' : 'none';
        document.getElementById('totalCount').textContent = total;
        document.getElementById('generateBtn').disabled = total === 0;
    }


    function openNonFssaiPreviewWindow(previewHtml) {
        console.log('[Non-FSSAI] Preview window opened');
        const win = window.open('', '_blank');
        win.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Non FSSAI Labels Preview</title>
                <style>
                    html, body { margin: 0; padding: 0; width: 4.094in; height: 2in; box-sizing: border-box;
                        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; font-size: 8px;
                        -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    body { display: flex; align-items: flex-start; justify-content: flex-start; background: #f8f9fa; padding: 0; }
                    .preview-labels { display: flex; flex-direction: column; gap: 0; padding: 0; margin: 0; }
                    .preview-label { background: #ffffff; border: 1px solid #000; width: 4.094in; height: 2in; box-sizing: border-box;
                        padding: 0.1in 0.1in; display: block; color: #000; font-size: 10px; line-height: 1.1; 
                        page-break-inside: avoid; page-break-after: always; margin: 0; position: relative; top: 0; }
                    .label-header { text-align: center; font-weight: bold; font-size: 14px; margin-bottom: 4px; border-bottom: 1px solid #000; padding-bottom: 2px; }
                    .label-content { font-size: 12px; line-height: 1.2; }
                    .label-row { margin-bottom: 2px; display: flex; justify-content: space-between; }
                    .label-field { font-weight: 600; }
                    .remarks-section { margin-top: 10px; padding-top: 4px; border-top: 1px dashed #666; font-size: 12px; text-align: center; }
                    .print-bar { margin: 10px 0; text-align: right; padding-right: 10px; }
                    .print-btn { background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 8px 20px; border: none; border-radius: 20px; font-size: 14px; cursor: pointer; font-weight: 600; }
                    @media print { .print-bar { display: none !important; } .preview-label { margin: 0 !important; padding: 0.15in 0.1in !important; border: 1px solid #000; page-break-after: always; height: 2in !important; } }
                </style>
            </head>
            <body>
                <div class="print-bar"><button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Labels</button></div>
                <div class="preview-labels">${previewHtml}</div>
            </body></html>`);
        win.document.close();
    }

    function generateLabels() {
        const labelType = document.getElementById('labelTypeSelect').value;
        switch(labelType) {
            case 'fssai-labels': generateFssaiLabels(); break;
            case 'airportFssai': generateAirportFssaiLabels(); break;
            case 'nonfssai': 
                console.log('[generateLabels] Calling generateNonFssaiLabels()');
                generateNonFssaiLabels();
                break; 
            console.log(nonfssai);
            case 'airportContinental': generateAirportContinentalLabels(); break;
            case 'intercity': generateIntercityLabels(); break;
            default: showStatus('Please select a label type first', 'error');
        }
    }

    function setupLabelTypeHandler() {
        const labelTypeSelect = document.getElementById('labelTypeSelect');
        const cityGroup = document.getElementById('cityGroup');
        
        labelTypeSelect.addEventListener('change', function() {
            currentLabelType = this.value;
            cityGroup.style.display = 'none';
            document.getElementById('batchNoInput').required = false; // Reset required
            
            if (currentLabelType === 'fssai-labels' || currentLabelType === 'airportFssai' || currentLabelType === 'airportContinental' || currentLabelType === 'nonfssai') {
                cityGroup.style.display = 'block';
                populateCities();
            } else if (currentLabelType === 'intercity') {
                cleanedItemsCache = cleanItemsData(excelData.intercity);
                populateDetailedItemsQuantities();
            }
            
            // Set batch no requirement based on type
            if (currentLabelType === 'fssai-labels') {
                document.getElementById('batchNoInput').required = true;
            }
        });

        document.getElementById('citySelect').addEventListener('change', function () {
            const selectedType = labelTypeSelect.value;
            console.log('[City Change] Type:', selectedType, 'City:', this.value);

            if (selectedType === 'fssai-labels') {
                loadFssaiLabelsItems(this.value);
            }
            else if (selectedType === 'airportFssai') {
                cleanedItemsCache = cleanItemsData(excelData.airportfssai);
                populateDetailedItemsQuantities();
            }
            else if (selectedType === 'airportContinental') {
                cleanedItemsCache = cleanItemsData(excelData.airportcontinental);
                populateDetailedItemsQuantities();
            }
            else if (selectedType === 'nonfssai') {
                console.log('[Non-FSSAI] Loading items');
                loadNonFssaiLabelsItems(this.value);
            }
        });
    }

    window.addEventListener('load', loadDataFromAppsScript);
</script>
</body>
</html>